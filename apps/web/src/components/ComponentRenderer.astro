---
/**
 * ComponentRenderer.astro
 * 
 * Renderiza componentes din√°micamente seg√∫n su tipo y variante
 * Soporta componentes est√°ndar y componentes personalizados (custom)
 */

import HeroDefault from './hero/HeroDefault.astro';
import HeroVariant1 from './hero/HeroVariant1.astro';
import HeroVariant2 from './hero/HeroVariant2.astro';
import HeroVariant3 from './hero/HeroVariant3.astro';
import HeroClic from './hero/HeroClic.astro';
import HeroSimple from './hero/HeroSimple.astro';
import HeroSearch from './hero/HeroSearch.astro';

import FooterDefault from './footer/FooterDefault.astro';
import HeaderDefault from './header/HeaderDefault.astro';

// Componentes de propiedades
import PropertyListDefault from './property-list/PropertyListDefault.astro';
import PropertyCardDefault from './property-card/PropertyCardDefault.astro';
import PropertyDetailDefault from './property-detail/PropertyDetailDefault.astro';
import PaginationDefault from './pagination/PaginationDefault.astro';

// Componentes de formularios
import ContactFormDefault from './contact-form/ContactFormDefault.astro';
import SearchBarDefault from './search-bar/SearchBarDefault.astro';
import FilterPanelDefault from './filter-panel/FilterPanelDefault.astro';

// Componentes de contenido
import CTADefault from './cta/CTADefault.astro';
import FeaturesDefault from './features/FeaturesDefault.astro';
import TestimonialsDefault from './testimonials/TestimonialsDefault.astro';
import TestimonialsClic from './testimonials/TestimonialsClic.astro';
import BlogListDefault from './blog-list/BlogListDefault.astro';

// Componentes CLIC Premium
import PropertyCarouselClic from './property-carousel/PropertyCarouselClic.astro';
import PropertyCarouselFeatured from './property-carousel/PropertyCarouselFeatured.astro';
import VideoGalleryClic from './video-gallery/VideoGalleryClic.astro';
import VideoGalleryDefault from './video-gallery/VideoGalleryDefault.astro';
import RelatedArticlesClic from './related-articles/RelatedArticlesClic.astro';
import PopularLocationsClic from './popular-locations/PopularLocationsClic.astro';
import DynamicFAQsClic from './dynamic-faqs/DynamicFAQsClic.astro';

// Componentes de Homepage
import FounderStoryClic from './founder-story/FounderStoryClic.astro';
import HomepageCTAClic from './homepage-cta/HomepageCTAClic.astro';

// Componentes de Listados/Grids
import TeamGridDefault from './team-grid/TeamGridDefault.astro';
import TestimonialGridDefault from './testimonial-grid/TestimonialGridDefault.astro';
import ArticleGridDefault from './article-grid/ArticleGridDefault.astro';
import PropertyGridDefault from './property-grid/PropertyGridDefault.astro';

// Componentes de Categor√≠as
import VideoCategoryListDefault from './category-list/VideoCategoryListDefault.astro';
import ArticleCategoryListDefault from './category-list/ArticleCategoryListDefault.astro';
import VideoCategoryDefault from './video-category/VideoCategoryDefault.astro';
import ArticleCategoryDefault from './article-category/ArticleCategoryDefault.astro';
import TestimonialCategoryDefault from './testimonial-category/TestimonialCategoryDefault.astro';

// Componentes de Detalle/Single
import AsesorDetailDefault from './asesor-detail/AsesorDetailDefault.astro';
import VideoDetailDefault from './video-detail/VideoDetailDefault.astro';
import ArticleDetailDefault from './article-detail/ArticleDetailDefault.astro';
import TestimonialDetailDefault from './testimonial-detail/TestimonialDetailDefault.astro';

// Placeholders para componentes no implementados a√∫n
import Placeholder from './placeholder/Placeholder.astro';

// Componentes personalizados (custom)
import CustomComponent from './custom/CustomComponent.astro';

import type { ComponenteConfigurado, TipoComponente, VarianteComponente } from '../types/componentes';
import type { ComponenteDataEstructurado } from '../types/componentesEstructurado';

interface Props {
  componente: ComponenteConfigurado;
  tema?: Record<string, string>;
  baseUrl?: string;
}

const { componente, tema = {}, baseUrl = '' } = Astro.props;

// Funci√≥n para obtener el componente correcto seg√∫n tipo y variante
function getComponent(tipo: TipoComponente, variante: VarianteComponente) {
  const componentMap: Record<string, any> = {
    // Layout
    'header-default': HeaderDefault,
    'footer-default': FooterDefault,
    'hero-default': HeroDefault,
    'hero-variant1': HeroVariant1,
    'hero-variant2': HeroVariant2,
    'hero-variant3': HeroVariant3,
    'hero-clic': HeroClic,
    'hero-simple': HeroSimple,
    'hero-search': HeroSearch,
    
    // Display
    'property_list-default': PropertyListDefault,
    'property_card-default': PropertyCardDefault,
    'property_detail-default': PropertyDetailDefault,
    'blog_list-default': BlogListDefault,
    
    // Navigation
    'pagination-default': PaginationDefault,
    
    // Forms
    'contact_form-default': ContactFormDefault,
    'search_bar-default': SearchBarDefault,
    'filter_panel-default': FilterPanelDefault,
    
    // Content
    'cta-default': CTADefault,
    'features-default': FeaturesDefault,
    'testimonials-default': TestimonialsDefault,
    'testimonials-clic': TestimonialsClic,
    
    // CLIC Premium Components
    'property_carousel-clic': PropertyCarouselClic,
    'property_carousel-default': PropertyCarouselFeatured,
    'property_carousel-featured': PropertyCarouselFeatured,
    'video_gallery-clic': VideoGalleryClic,
    'video_gallery-default': VideoGalleryDefault,
    'related_articles-clic': RelatedArticlesClic,
    'popular_locations-clic': PopularLocationsClic,
    'dynamic_faqs-clic': DynamicFAQsClic,

    // Homepage Components
    'founder_story-default': FounderStoryClic,
    'founder_story-clic': FounderStoryClic,
    'homepage_cta-default': HomepageCTAClic,
    'homepage_cta-clic': HomepageCTAClic,

    // Grid/Listing Components
    'team_grid-default': TeamGridDefault,
    'testimonial_grid-default': TestimonialGridDefault,
    'article_grid-default': ArticleGridDefault,
    'property_grid-default': PropertyGridDefault,

    // Detail/Single Components
    'agent_profile-default': AsesorDetailDefault,
    'asesor_detail-default': AsesorDetailDefault,
    'asesor-detail-default': AsesorDetailDefault,
    'video_detail-default': VideoDetailDefault,
    'article_detail-default': ArticleDetailDefault,
    'testimonial_detail-default': TestimonialDetailDefault,
    'testimonio_detail-default': TestimonialDetailDefault,

    // Content component - mapea seg√∫n dataType al componente adecuado
    // Por ahora usa TeamGrid como fallback para asesores
    'content-default': TeamGridDefault,
  };

  const key = `${tipo}-${variante}`;
  const component = componentMap[key];
  
  // Si no se encuentra el componente con la variante especificada, intentar con la primera variante disponible
  // Esto es √∫til para componentes CLIC que solo tienen variante 'clic' pero se crean con 'default'
  if (!component) {
    const tipoKey = tipo as keyof typeof componentMap;
    // Buscar cualquier variante de este tipo
    const availableKeys = Object.keys(componentMap).filter(k => k.startsWith(`${tipo}-`));
    if (availableKeys.length > 0) {
      // Retornar la primera variante disponible de este tipo
      return componentMap[availableKeys[0] as keyof typeof componentMap] || null;
    }
  }
  
  return component || null;
}

// Para componentes de tipo 'content', elegir el componente seg√∫n el dataType
function getContentComponent(dataType: string | undefined) {
  const contentComponentMap: Record<string, any> = {
    // Listados principales
    'lista_asesores': TeamGridDefault,
    'lista_videos': VideoGalleryDefault,
    'lista_articulos': ArticleGridDefault,
    'lista_propiedades': PropertyGridDefault,
    'lista_testimonios': TestimonialGridDefault,

    // Singles/Detalle
    'asesor_single': AsesorDetailDefault,
    'video_single': VideoDetailDefault,
    'articulo_single': ArticleDetailDefault,
    'testimonio_single': TestimonialDetailDefault,

    // Lista de categor√≠as (muestra todas las categor√≠as)
    'categorias_videos': VideoCategoryListDefault,
    'categorias_articulos': ArticleCategoryListDefault,
    'videos_por_categoria': VideoCategoryListDefault,  // Alias usado en plantillas
    'articulos_por_categoria': ArticleCategoryListDefault,  // Alias usado en plantillas

    // Categor√≠a espec√≠fica (muestra items de UNA categor√≠a)
    'categoria_videos': VideoCategoryDefault,
    'categoria_articulos': ArticleCategoryDefault,
    'categoria_testimonios': TestimonialCategoryDefault,
  };
  return contentComponentMap[dataType || ''] || null;
}

let Component = getComponent(componente.tipo, componente.variante);
const isCustom = componente.tipo === 'custom';

// Si es un componente content, usar el componente espec√≠fico seg√∫n dataType
if (componente.tipo === 'content') {
  const dataType = componente.datos?.dynamic_data?.dataType;
  console.log(`üîç [ComponentRenderer] content dataType: ${dataType}`);
  const contentComponent = getContentComponent(dataType);
  if (contentComponent) {
    console.log(`‚úÖ [ComponentRenderer] Usando componente espec√≠fico para ${dataType}`);
    Component = contentComponent;
  } else {
    console.log(`‚ö†Ô∏è [ComponentRenderer] No hay componente espec√≠fico para ${dataType}, usando fallback`);
  }
}

// Debug: Verificar que tenemos datos
if (!componente.datos) {
  console.warn(`‚ö†Ô∏è Componente ${componente.tipo} (${componente.variante}) no tiene datos`);
}

// Debug: Verificar que el componente est√° mapeado
if (!isCustom && !Component) {
  console.warn(`‚ö†Ô∏è Componente ${componente.tipo}-${componente.variante} no est√° mapeado`);
  console.warn(`üîç Clave buscada: ${componente.tipo}-${componente.variante}`);
}

---

{isCustom ? (
  <CustomComponent
    componente={componente}
    tema={tema}
    baseUrl={baseUrl}
  />
) : componente.tipo === 'property_detail' ? (
  <PropertyDetailDefault
    datos={componente.datos}
    tema={tema}
    baseUrl={baseUrl}
  />
) : Component ? (
  <Component
    datos={componente.datos || { static_data: {}, styles: {}, toggles: {} }}
    tema={tema}
    baseUrl={baseUrl}
  />
) : (
  <Placeholder
    tipo={componente.tipo}
    variante={componente.variante}
  />
)}
<style>
  .component-error {
    padding: 2rem;
    background: #fed7d7;
    color: #742a2a;
    border-radius: 8px;
    text-align: center;
  }
</style>


