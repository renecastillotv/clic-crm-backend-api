---
/**
 * HeaderClic.astro
 * Header estilo CLIC Inmobiliaria
 *
 * CONFIGURACION (static_data):
 * - logo: URL del logo
 * - logoAlt: Texto alternativo del logo
 * - links: Array de {texto, url, icono?} para navegaci贸n
 * - textoBotonContacto: Texto del bot贸n contacto
 * - urlBotonContacto: URL del bot贸n contacto
 * - telefono: N煤mero de tel茅fono
 * - idiomas: Array de {codigo, nombre, bandera} para selector de idiomas
 *
 * TOGGLES:
 * - mostrarIdiomas: Mostrar selector de idiomas
 * - mostrarFavoritos: Mostrar bot贸n de favoritos
 * - mostrarTelefono: Mostrar tel茅fono
 * - mostrarBotonContacto: Mostrar bot贸n de contacto
 *
 * COLORES (styles):
 * - colorPrimario: Color primario (default: #f04e00 - naranja CLIC)
 * - colorFondo: Color de fondo del header
 * - colorTexto: Color del texto
 */

import type { ComponenteDataEstructurado } from '../../types/componentesEstructurado';

interface Props {
  datos: ComponenteDataEstructurado;
  tema?: Record<string, string>;
  baseUrl?: string;
}

interface Enlace {
  texto: string;
  url: string;
  icono?: string;
}

interface Idioma {
  codigo: string;
  nombre: string;
  bandera: string;
}

const { datos, tema = {}, baseUrl = '' } = Astro.props;

// Acceso a datos estructurados
const staticData = datos?.static_data || {};
const styles = datos?.styles || {};
const toggles = datos?.toggles || {};

// === DATOS BASICOS ===
const logo = staticData.logo || '/logo.png';
const logoAlt = staticData.logoAlt || 'CLIC Inmobiliaria';
// Enlaces por defecto seg煤n dise帽o de pa.clicinmobiliaria.com
const links: Enlace[] = Array.isArray(staticData.links) ? staticData.links : [
  { texto: 'Comprar', url: '/propiedades?operacion=venta' },
  { texto: 'Alquilar', url: '/propiedades?operacion=renta' },
  { texto: 'Vender', url: '/vender' },
  { texto: 'Asesores', url: '/asesores' },
  { texto: 'Video', url: '/videos' },
  { texto: 'Art铆culo', url: '/articulos' }
];
const textoBotonContacto = staticData.textoBotonContacto || 'Contacto';
const urlBotonContacto = staticData.urlBotonContacto || '/contacto';
const telefono = staticData.telefono || '';

// Idiomas por defecto
const idiomasDefault: Idioma[] = [
  { codigo: 'es', nombre: 'Espa帽ol', bandera: '拆' },
  { codigo: 'en', nombre: 'English', bandera: '吼' },
  { codigo: 'fr', nombre: 'Fran莽ais', bandera: '' }
];
const idiomas: Idioma[] = Array.isArray(staticData.idiomas) ? staticData.idiomas : idiomasDefault;
const idiomaActual = idiomas[0] || idiomasDefault[0];

// === TOGGLES ===
const mostrarIdiomas = toggles.mostrarIdiomas !== false;
const mostrarFavoritos = toggles.mostrarFavoritos !== false;
const mostrarTelefono = toggles.mostrarTelefono === true && telefono;
const mostrarBotonContacto = toggles.mostrarBotonContacto !== false;

// === COLORES CONFIGURABLES ===
// Todos los colores vienen de styles o tema, con valores por defecto de CLIC
const colorPrimario = styles.colorPrimario || tema.primary || '#f04e00';
const colorFondo = styles.colorFondo || tema.background || '#ffffff';
const colorTexto = styles.colorTexto || tema.text || '#1f2937';
const colorBorde = styles.colorBorde || tema.border || '#e5e7eb';
const colorHover = styles.colorHover || tema.hover || '#f3f4f6';
const colorTextoOnPrimary = styles.colorTextoOnPrimary || tema.textOnPrimary || '#ffffff';
const colorSombra = styles.colorSombra || 'rgba(0, 0, 0, 0.1)';
---

<header
  class="header-clic"
  style={`
    --hc-primario: ${colorPrimario};
    --hc-fondo: ${colorFondo};
    --hc-texto: ${colorTexto};
    --hc-borde: ${colorBorde};
    --hc-hover: ${colorHover};
    --hc-texto-on-primary: ${colorTextoOnPrimary};
    --hc-sombra: ${colorSombra};
  `}
>
  <div class="header-container">
    <div class="header-content">
      {/* Logo */}
      <a href={`${baseUrl}/`} class="header-logo">
        {logo ? (
          <img src={logo} alt={logoAlt} />
        ) : (
          <span class="logo-text">{logoAlt}</span>
        )}
      </a>

      {/* Navegaci贸n Desktop */}
      <nav class="header-nav" translate="no">
        {links.map((enlace) => (
          <a
            href={enlace.url.startsWith('/') ? `${baseUrl}${enlace.url}` : enlace.url}
            class="nav-link"
          >
            {enlace.texto}
          </a>
        ))}
      </nav>

      {/* Acciones */}
      <div class="header-actions">
        {/* Selector de Idioma */}
        {mostrarIdiomas && idiomas.length > 0 && (
          <div class="language-selector">
            <button class="language-btn" type="button" aria-label="Seleccionar idioma">
              <span class="flag">{idiomaActual.bandera || (
                <svg class="globe-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="2" y1="12" x2="22" y2="12"/>
                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
              )}</span>
              <span class="lang-code">{idiomaActual.codigo.toUpperCase()}</span>
              <svg class="chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
            <div class="language-dropdown">
              {idiomas.map((idioma) => (
                <a
                  href={idioma.codigo === 'es' ? `${baseUrl}/` : `${baseUrl}/${idioma.codigo}`}
                  class={`language-option ${idioma.codigo === idiomaActual.codigo ? 'active' : ''}`}
                >
                  <span class="flag">{idioma.bandera || (
                    <svg class="globe-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="2" y1="12" x2="22" y2="12"/>
                      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                  )}</span>
                  <span>{idioma.nombre}</span>
                </a>
              ))}
            </div>
          </div>
        )}

        {/* Tel茅fono */}
        {mostrarTelefono && (
          <a href={`tel:${telefono}`} class="header-phone">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
            </svg>
            <span>{telefono}</span>
          </a>
        )}

        {/* Favoritos */}
        {mostrarFavoritos && (
          <a href={`${baseUrl}/favoritos`} class="favorites-btn" aria-label="Ver favoritos">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            <span class="favorites-count" id="favorites-count">0</span>
          </a>
        )}

        {/* Bot贸n Contacto */}
        {mostrarBotonContacto && (
          <a
            href={urlBotonContacto.startsWith('/') ? `${baseUrl}${urlBotonContacto}` : urlBotonContacto}
            class="contact-btn"
          >
            {textoBotonContacto}
          </a>
        )}

        {/* Bot贸n Men煤 M贸vil */}
        <button class="mobile-menu-btn" type="button" aria-label="Abrir men煤">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  {/* Men煤 M贸vil */}
  <div class="mobile-menu" id="mobile-menu">
    <div class="mobile-menu-content">
      <nav class="mobile-nav">
        {links.map((enlace) => (
          <a
            href={enlace.url.startsWith('/') ? `${baseUrl}${enlace.url}` : enlace.url}
            class="mobile-nav-link"
          >
            {enlace.texto}
          </a>
        ))}
      </nav>

      {mostrarBotonContacto && (
        <a
          href={urlBotonContacto.startsWith('/') ? `${baseUrl}${urlBotonContacto}` : urlBotonContacto}
          class="mobile-contact-btn"
        >
          {textoBotonContacto}
        </a>
      )}

      {mostrarIdiomas && (
        <div class="mobile-languages">
          {idiomas.map((idioma) => (
            <a
              href={idioma.codigo === 'es' ? `${baseUrl}/` : `${baseUrl}/${idioma.codigo}`}
              class={`mobile-lang-btn ${idioma.codigo === idiomaActual.codigo ? 'active' : ''}`}
            >
              <span class="flag">{idioma.bandera || (
                <svg class="globe-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="2" y1="12" x2="22" y2="12"/>
                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
              )}</span>
              <span>{idioma.codigo.toUpperCase()}</span>
            </a>
          ))}
        </div>
      )}
    </div>
  </div>
</header>

<style>
  .header-clic {
    position: sticky;
    top: 0;
    z-index: 50;
    background: var(--hc-fondo);
    box-shadow: 0 1px 3px 0 var(--hc-sombra);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, sans-serif;
  }

  .header-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 72px;
  }

  /* Logo */
  .header-logo {
    display: flex;
    align-items: center;
    text-decoration: none;
  }

  .header-logo img {
    height: 48px;
    width: auto;
  }

  .logo-text {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--hc-primario);
  }

  /* Navegaci贸n Desktop */
  .header-nav {
    display: none;
    align-items: center;
    gap: 2.5rem;
  }

  @media (min-width: 768px) {
    .header-nav {
      display: flex;
    }
  }

  .nav-link {
    position: relative;
    color: var(--hc-texto);
    text-decoration: none;
    font-size: 1.0625rem;
    font-weight: 500;
    padding: 0.5rem 0;
    transition: color 0.2s;
  }

  .nav-link:hover {
    color: var(--hc-primario);
  }

  .nav-link::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--hc-primario);
    transition: width 0.2s;
  }

  .nav-link:hover::after,
  .nav-link.active::after {
    width: 100%;
  }

  /* Acciones */
  .header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  /* Selector de Idioma */
  .language-selector {
    position: relative;
    display: none;
  }

  @media (min-width: 768px) {
    .language-selector {
      display: block;
    }
  }

  .language-btn {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: 1px solid var(--hc-borde);
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--hc-texto);
    transition: border-color 0.2s;
  }

  .language-btn:hover {
    border-color: var(--hc-primario);
  }

  .flag {
    font-size: 1rem;
  }

  .lang-code {
    font-weight: 500;
  }

  .chevron {
    transition: transform 0.2s;
  }

  .language-selector:hover .chevron {
    transform: rotate(180deg);
  }

  .language-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.5rem;
    background: var(--hc-fondo);
    border: 1px solid var(--hc-borde);
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px var(--hc-sombra);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-0.5rem);
    transition: all 0.2s;
    min-width: 150px;
    overflow: hidden;
  }

  .language-selector:hover .language-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .language-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    color: var(--hc-texto);
    text-decoration: none;
    transition: background 0.2s;
  }

  .language-option:hover {
    background: var(--hc-hover);
  }

  .language-option.active {
    background: var(--hc-hover);
    color: var(--hc-primario);
  }

  /* Tel茅fono */
  .header-phone {
    display: none;
    align-items: center;
    gap: 0.5rem;
    color: var(--hc-texto);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
  }

  @media (min-width: 1024px) {
    .header-phone {
      display: flex;
    }
  }

  .header-phone:hover {
    color: var(--hc-primario);
  }

  /* Favoritos */
  .favorites-btn {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.5rem;
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--hc-texto);
    transition: color 0.2s;
    text-decoration: none;
    gap: 2px;
  }

  .favorites-btn:hover {
    color: var(--hc-primario);
  }

  .favorites-count {
    font-size: 0.625rem;
    font-weight: 600;
    color: var(--hc-texto);
    background: var(--hc-hover);
    padding: 1px 6px;
    border-radius: 9999px;
    min-width: 18px;
    text-align: center;
  }

  .favorites-btn:hover .favorites-count {
    background: var(--hc-primario);
    color: var(--hc-texto-on-primary);
  }

  /* Bot贸n Contacto */
  .contact-btn {
    display: none;
    padding: 0.75rem 1.75rem;
    border: 2px solid var(--hc-primario);
    border-radius: 0.5rem;
    color: var(--hc-primario);
    text-decoration: none;
    font-size: 1.0625rem;
    font-weight: 600;
    transition: all 0.2s;
  }

  @media (min-width: 768px) {
    .contact-btn {
      display: block;
    }
  }

  .contact-btn:hover {
    background: var(--hc-primario);
    color: var(--hc-texto-on-primary);
  }

  /* Bot贸n Men煤 M贸vil */
  .mobile-menu-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--hc-texto);
  }

  @media (min-width: 768px) {
    .mobile-menu-btn {
      display: none;
    }
  }

  /* Men煤 M贸vil */
  .mobile-menu {
    position: fixed;
    top: 72px;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--hc-fondo);
    transform: translateX(100%);
    transition: transform 0.3s ease-in-out;
    z-index: 40;
    overflow-y: auto;
  }

  .mobile-menu.open {
    transform: translateX(0);
  }

  .mobile-menu-content {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .mobile-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .mobile-nav-link {
    display: block;
    padding: 0.75rem 1rem;
    color: var(--hc-texto);
    text-decoration: none;
    font-size: 1rem;
    font-weight: 500;
    border-radius: 0.5rem;
    transition: background 0.2s;
  }

  .mobile-nav-link:hover {
    background: var(--hc-hover);
    color: var(--hc-primario);
  }

  .mobile-contact-btn {
    display: block;
    padding: 0.75rem 1rem;
    background: var(--hc-primario);
    color: var(--hc-texto-on-primary);
    text-decoration: none;
    text-align: center;
    font-weight: 600;
    border-radius: 0.5rem;
    transition: opacity 0.2s;
  }

  .mobile-contact-btn:hover {
    opacity: 0.9;
  }

  .mobile-languages {
    display: flex;
    gap: 0.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--hc-borde);
  }

  .mobile-lang-btn {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--hc-borde);
    border-radius: 0.375rem;
    color: var(--hc-texto);
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .mobile-lang-btn:hover,
  .mobile-lang-btn.active {
    border-color: var(--hc-primario);
    color: var(--hc-primario);
  }
</style>

<script>
  // Toggle men煤 m贸vil
  const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');

  if (mobileMenuBtn && mobileMenu) {
    mobileMenuBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('open');

      // Cambiar icono
      const isOpen = mobileMenu.classList.contains('open');
      mobileMenuBtn.innerHTML = isOpen
        ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'
        : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
    });
  }

  // Actualizar contador de favoritos desde localStorage
  function updateFavoritesCount() {
    const countEl = document.getElementById('favorites-count');
    if (countEl) {
      try {
        const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        countEl.textContent = String(favorites.length);
      } catch (e) {
        countEl.textContent = '0';
      }
    }
  }

  // Ejecutar al cargar
  updateFavoritesCount();

  // Escuchar cambios en localStorage
  window.addEventListener('storage', updateFavoritesCount);
</script>
