---
/**
 * PropertyDetailDefault.astro
 * Componente para mostrar los detalles completos de una propiedad individual
 * Puede recibir propiedad directamente o desde datos.propiedad
 */

import type { ComponenteDataEstructurado } from '../../types/componentesEstructurado';

interface Props {
  datos?: ComponenteDataEstructurado;
  propiedad?: any; // Datos de la propiedad desde resolvedData
  tema?: Record<string, string>;
  baseUrl?: string;
}

const { datos, propiedad: propiedadDirecta, tema = {}, baseUrl = '' } = Astro.props;

// Obtener propiedad desde datos.propiedad (si viene del sistema de componentes) o directamente
const propiedad = (datos as any)?.propiedad || propiedadDirecta || (datos as any)?.dynamic_data?.resolved?.[0];

// Flag para mostrar estado "no encontrado"
const propiedadNoEncontrada = !propiedad;

const primaryColor = tema.primary || '#667eea';
const secondaryColor = tema.secondary || '#764ba2';
const textColor = tema.text || '#1a202c';
const backgroundColor = tema.background || '#ffffff';
const borderColor = tema.border || '#e2e8f0';

// Normalizar datos de la propiedad (pueden venir con diferentes nombres de campo)
const imagenPrincipal = propiedad?.imagen_principal || propiedad?.imagenPrincipal;
const imagenesGaleria = propiedad?.imagenes || [];
const imagenes = imagenPrincipal ? [imagenPrincipal, ...imagenesGaleria] : imagenesGaleria;

const titulo = propiedad?.titulo || 'Propiedad';
const descripcion = propiedad?.descripcion;
const precio = parseFloat(propiedad?.precio) || 0;
const moneda = propiedad?.moneda || 'USD';
const operacion = propiedad?.operacion;
const tipo = propiedad?.tipo;
const estado = propiedad?.estado_propiedad || propiedad?.estado;

// Ubicaci√≥n
const ciudad = propiedad?.ciudad;
const sector = propiedad?.sector;
const direccion = propiedad?.direccion;
const ubicacion = [sector, ciudad].filter(Boolean).join(', ') || direccion || '';

// Caracter√≠sticas
const habitaciones = propiedad?.habitaciones;
const banos = propiedad?.banos;
const metros = propiedad?.m2_construccion ? parseFloat(propiedad.m2_construccion) : (propiedad?.metros || null);
const estacionamientos = propiedad?.estacionamientos;

const caracteristicas = propiedad?.caracteristicas || {};
const amenidades = propiedad?.amenidades || [];
---

{propiedadNoEncontrada ? (
  <section class="property-not-found" style="padding: 4rem 2rem; max-width: 800px; margin: 0 auto; text-align: center;">
    <div style="
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      padding: 4rem 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    ">
      <div style="font-size: 5rem; margin-bottom: 1.5rem;">üè†</div>
      <h1 style="
        font-size: 2rem;
        font-weight: 700;
        color: #1a202c;
        margin: 0 0 1rem 0;
      ">
        Propiedad no encontrada
      </h1>
      <p style="
        color: #718096;
        font-size: 1.1rem;
        margin: 0 0 2rem 0;
        line-height: 1.6;
      ">
        La propiedad que buscas no existe o ha sido removida de nuestro cat√°logo.
      </p>
      <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <a
          href={`${baseUrl}/`}
          style="
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            background: var(--primary-color, #667eea);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
          "
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          Volver al inicio
        </a>
        <a
          href={`${baseUrl}/propiedades`}
          style="
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            background: white;
            color: var(--primary-color, #667eea);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            border: 2px solid var(--primary-color, #667eea);
            transition: transform 0.2s, box-shadow 0.2s;
          "
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          Ver todas las propiedades
        </a>
      </div>
    </div>
  </section>
) : (
<section class="property-detail" style="padding: 2rem 1rem; max-width: 1200px; margin: 0 auto;">
  <!-- Galer√≠a de im√°genes -->
  {imagenes.length > 0 ? (
    <div class="property-gallery" style="margin-bottom: 2rem;">
      <div class="main-image" style="
        width: 100%;
        height: 400px;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
      ">
        <img
          src={imagenes[0]}
          alt={titulo}
          style="width: 100%; height: 100%; object-fit: cover;"
        />
      </div>
      {imagenes.length > 1 && (
        <div class="thumbnail-grid" style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 1rem;
        ">
          {imagenes.slice(1, 5).map((imagen: string) => (
            <div style="
              width: 100%;
              height: 150px;
              border-radius: 8px;
              overflow: hidden;
              background: var(--border-color, #e2e8f0);
            ">
              <img
                src={imagen}
                alt={titulo}
                style="width: 100%; height: 100%; object-fit: cover;"
              />
            </div>
          ))}
        </div>
      )}
    </div>
  ) : (
    <div class="property-image-placeholder" style="
      width: 100%;
      height: 400px;
      border-radius: 8px;
      margin-bottom: 2rem;
      background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 4rem;
    ">
      üè†
    </div>
  )}

  <div class="property-content" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Contenido principal -->
    <div class="property-main">
      <!-- T√≠tulo y precio -->
      <header style="margin-bottom: 1.5rem;">
        {operacion && (
          <span style="
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary-color, #667eea);
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
          ">
            {operacion === 'venta' ? 'En Venta' : operacion === 'renta' ? 'En Alquiler' : operacion}
          </span>
        )}
        <h1 style="
          font-size: 2.5rem;
          font-weight: 700;
          color: var(--text-color, #1a202c);
          margin-bottom: 0.5rem;
        ">
          {titulo}
        </h1>
        <div style="
          display: flex;
          align-items: center;
          gap: 1rem;
          margin-bottom: 1rem;
          flex-wrap: wrap;
        ">
          <p style="
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color, #667eea);
            margin: 0;
          ">
            {moneda === 'USD' ? '$' : moneda}{precio.toLocaleString()}
            {operacion === 'renta' && <span style="font-size: 1rem; font-weight: 400;">/mes</span>}
          </p>
          {estado && (
            <span style="
              padding: 0.25rem 0.75rem;
              background: var(--success-color, #48bb78);
              color: white;
              border-radius: 4px;
              font-size: 0.9rem;
              font-weight: 600;
              text-transform: capitalize;
            ">
              {estado}
            </span>
          )}
        </div>
        {ubicacion && (
          <p style="
            color: var(--text-secondary, #718096);
            font-size: 1.1rem;
            margin: 0;
          ">
            üìç {ubicacion}
          </p>
        )}
      </header>

      <!-- Caracter√≠sticas principales -->
      <div class="property-features" style="
        display: flex;
        gap: 2rem;
        padding: 1.5rem;
        background: var(--border-color, #f7fafc);
        border-radius: 8px;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      ">
        {habitaciones && (
          <div style="text-align: center; min-width: 80px;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üõèÔ∏è</div>
            <div style="font-weight: 600; color: var(--text-color, #1a202c);">
              {habitaciones}
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary, #718096);">
              Habitaciones
            </div>
          </div>
        )}
        {banos && (
          <div style="text-align: center; min-width: 80px;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üöø</div>
            <div style="font-weight: 600; color: var(--text-color, #1a202c);">
              {banos}
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary, #718096);">
              Ba√±os
            </div>
          </div>
        )}
        {metros && (
          <div style="text-align: center; min-width: 80px;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìê</div>
            <div style="font-weight: 600; color: var(--text-color, #1a202c);">
              {metros} m¬≤
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary, #718096);">
              Superficie
            </div>
          </div>
        )}
        {estacionamientos && (
          <div style="text-align: center; min-width: 80px;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üöó</div>
            <div style="font-weight: 600; color: var(--text-color, #1a202c);">
              {estacionamientos}
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary, #718096);">
              Estacionamientos
            </div>
          </div>
        )}
        {tipo && (
          <div style="text-align: center; min-width: 80px;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üèòÔ∏è</div>
            <div style="font-weight: 600; color: var(--text-color, #1a202c); text-transform: capitalize;">
              {tipo}
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary, #718096);">
              Tipo
            </div>
          </div>
        )}
      </div>

      <!-- Descripci√≥n -->
      {descripcion && (
        <div class="property-description" style="margin-bottom: 2rem;">
          <h2 style="
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color, #1a202c);
            margin-bottom: 1rem;
          ">
            Descripci√≥n
          </h2>
          <p style="
            color: var(--text-color, #1a202c);
            line-height: 1.8;
            font-size: 1.1rem;
          ">
            {descripcion}
          </p>
        </div>
      )}

      <!-- Caracter√≠sticas adicionales -->
      {Object.keys(caracteristicas).length > 0 && (
        <div class="property-amenities" style="margin-bottom: 2rem;">
          <h2 style="
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color, #1a202c);
            margin-bottom: 1rem;
          ">
            Caracter√≠sticas
          </h2>
          <div style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
          ">
            {Object.entries(caracteristicas).map(([key, value]) => (
              value && (
                <div style="
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                  padding: 0.75rem;
                  background: var(--border-color, #f7fafc);
                  border-radius: 4px;
                ">
                  <span style="font-size: 1.2rem;">‚úÖ</span>
                  <span style="color: var(--text-color, #1a202c); text-transform: capitalize;">
                    {key.replace(/([A-Z])/g, ' $1').trim()}
                  </span>
                </div>
              )
            ))}
          </div>
        </div>
      )}
    </div>

    <!-- Sidebar -->
    <aside class="property-sidebar" style="
      position: sticky;
      top: 2rem;
      height: fit-content;
    ">
      <div style="
        padding: 1.5rem;
        background: var(--border-color, #f7fafc);
        border-radius: 8px;
        border: 1px solid var(--border-color, #e2e8f0);
      ">
        <h3 style="
          font-size: 1.25rem;
          font-weight: 700;
          color: var(--text-color, #1a202c);
          margin-bottom: 1rem;
        ">
          Solicitar Informaci√≥n
        </h3>
        <p style="
          color: var(--text-secondary, #718096);
          margin-bottom: 1.5rem;
          font-size: 0.9rem;
        ">
          Completa el formulario y te contactaremos pronto.
        </p>
        <form style="display: flex; flex-direction: column; gap: 1rem;">
          <input 
            type="text" 
            placeholder="Tu nombre"
            style="
              padding: 0.75rem;
              border: 1px solid var(--border-color, #e2e8f0);
              border-radius: 4px;
              font-size: 1rem;
            "
          />
          <input 
            type="email" 
            placeholder="Tu email"
            style="
              padding: 0.75rem;
              border: 1px solid var(--border-color, #e2e8f0);
              border-radius: 4px;
              font-size: 1rem;
            "
          />
          <input 
            type="tel" 
            placeholder="Tu tel√©fono"
            style="
              padding: 0.75rem;
              border: 1px solid var(--border-color, #e2e8f0);
              border-radius: 4px;
              font-size: 1rem;
            "
          />
          <textarea 
            placeholder="Mensaje (opcional)"
            rows="4"
            style="
              padding: 0.75rem;
              border: 1px solid var(--border-color, #e2e8f0);
              border-radius: 4px;
              font-size: 1rem;
              resize: vertical;
            "
          ></textarea>
          <button 
            type="submit"
            style="
              padding: 0.75rem 1.5rem;
              background: var(--primary-color, #667eea);
              color: white;
              border: none;
              border-radius: 4px;
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              transition: transform 0.2s, box-shadow 0.2s;
            "
          >
            Enviar Solicitud
          </button>
        </form>
      </div>
    </aside>
  </div>
</section>
)}

<style is:global>
  .property-detail {
    width: 100%;
    display: block;
  }

  @media (max-width: 768px) {
    .property-content {
      grid-template-columns: 1fr !important;
    }

    .property-sidebar {
      position: static !important;
    }
  }
</style>

