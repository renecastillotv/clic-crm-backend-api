---
/**
 * PopularLocationsClic.astro - COPIA FIEL DEL ORIGINAL
 * 100% fiel al dise√±o de pa.clicinmobiliaria.com
 * Dise√±o estilo VALLA PUBLICITARIA con carrusel
 * Adaptado al sistema de datos estructurados (frontend desacoplado)
 */

import type { ComponenteDataEstructurado } from '../../types/componentesEstructurado';

interface Props {
  datos: ComponenteDataEstructurado;
  tema?: Record<string, string>;
  baseUrl?: string;
}

const { datos, tema = {}, baseUrl = '' } = Astro.props;

const staticData = datos?.static_data || {};
const dynamicData = datos?.dynamic_data || {};
const styles = datos?.styles || {};

// === COLORES CONFIGURABLES ===
const colorPrimario = styles.colorPrimario || tema?.primary || '#f04e00';
const colorTexto = styles.colorTexto || tema?.text || '#111827';
const colorTextoSecondary = styles.colorTextoSecondary || tema?.textSecondary || '#4b5563';
const colorFondo = styles.colorFondo || tema?.background || '#f9fafb';
const colorBorde = styles.colorBorde || tema?.border || '#d1d5db';
const colorBordeHover = styles.colorBordeHover || colorPrimario;
const colorTextoHover = styles.colorTextoHover || colorPrimario;

// Configuraci√≥n
const title = staticData.titulo;
const subtitle = staticData.subtitulo;
const showType = staticData.showType || 'mixed';
const dataSource = staticData.dataSource || 'edge_function';
const showBadges = staticData.showBadges !== false;
const language = staticData.language || 'es';
const layout = staticData.layout || 'grid';

// Datos din√°micos (ubicaciones/sectores)
const rawLocations = dynamicData?.resolved || [];
const locations = Array.isArray(rawLocations) ? rawLocations : [];

// Traducciones - EXACTAS del original
const translations = {
  es: {
    properties: 'propiedades',
    from: 'Desde',
    viewAllLocations: 'Ver todas las ubicaciones',
    previousLocations: 'Ver ubicaciones anteriores',
    moreLocations: 'Ver m√°s ubicaciones',
    propertiesIn: 'Propiedades en',
    titles: {
      real_data: "Ubicaciones con Mayor Demanda",
      edge_function: "Destinos de inversi√≥n destacados",
      expert_zones: "Ubicaciones donde Ren√© y su Equipo son Expertos"
    },
    subtitles: {
      real_data: "Basado en nuestro inventario actual y actividad de b√∫squeda",
      edge_function: "Oportunidades inmobiliarias en las zonas m√°s prometedoras del pa√≠s",
      expert_zones: "Con 6 a√±os de experiencia, conocemos cada zona y sabemos d√≥nde est√°n las mejores oportunidades"
    }
  },
  en: {
    properties: 'properties',
    from: 'From',
    viewAllLocations: 'View all locations',
    previousLocations: 'View previous locations',
    moreLocations: 'View more locations',
    propertiesIn: 'Properties in',
    titles: {
      real_data: "Most In-Demand Locations",
      edge_function: "Featured Investment Destinations",
      expert_zones: "Locations where Ren√© and his Team are Experts"
    },
    subtitles: {
      real_data: "Based on our current inventory and search activity",
      edge_function: "Real estate opportunities in the country's most promising areas",
      expert_zones: "With 6 years of experience, we know every area and where the best opportunities are"
    }
  },
  fr: {
    properties: 'propri√©t√©s',
    from: '√Ä partir de',
    viewAllLocations: 'Voir tous les emplacements',
    previousLocations: 'Voir les emplacements pr√©c√©dents',
    moreLocations: 'Voir plus d\'emplacements',
    propertiesIn: 'Propri√©t√©s √†',
    titles: {
      real_data: "Emplacements les Plus Demand√©s",
      edge_function: "Destinations d'Investissement en Vedette",
      expert_zones: "Emplacements o√π Ren√© et son √âquipe sont Experts"
    },
    subtitles: {
      real_data: "Bas√© sur notre inventaire actuel et l'activit√© de recherche",
      edge_function: "Opportunit√©s immobili√®res dans les zones les plus prometteuses du pays",
      expert_zones: "Avec 6 ans d'exp√©rience, nous connaissons chaque zone et savons o√π se trouvent les meilleures opportunit√©s"
    }
  }
};

const t = translations[language] || translations.es;

// T√≠tulos din√°micos
const finalTitle = title || t.titles[dataSource] || t.titles.edge_function;
const finalSubtitle = subtitle || t.subtitles[dataSource] || t.subtitles.edge_function;

// No renderizar si no hay datos
if (!locations || locations.length === 0) return null;

// Funci√≥n para crear nombres cortos estilo VALLA PUBLICITARIA - EXACTO del original
function createBillboardName(originalName: string): string {
  const nameMap = {
    'Santiago - Segunda Ciudad del Pa√≠s': 'SANTIAGO',
    'Juan Dolio - Para√≠so Costero de Inversi√≥n': 'JUAN DOLIO',
    'Santo Domingo Norte - Crecimiento Acelerado': 'STO DGO NORTE',
    'Santo Domingo Este - Zona Residencial Premium': 'STO DGO ESTE',
    'Saman√° - Joya Natural Emergente': 'SAMAN√Å',
    'Distrito Nacional - Centro de Inversi√≥n': 'DISTRITO NACIONAL',
    'Punta Cana - Destino Tur√≠stico #1': 'PUNTA CANA',
    'La Jacobo - Oportunidad Emergente': 'LA JACOBO',
    'San Isidro - Desarrollo Acelerado': 'SAN ISIDRO',
    'Bella Vista - Tradici√≥n y Modernidad': 'BELLA VISTA',
    'Alma Rosa - Residencial Familiar': 'ALMA ROSA',
    'Av. Ecol√≥gica - Naturaleza y Ciudad': 'AV. ECOL√ìGICA',
    'Piantini - Exclusividad y Lujo': 'PIANTINI',
    'Naco - Sector Comercial Premium': 'NACO'
  };

  if (nameMap[originalName]) {
    return nameMap[originalName];
  }

  return originalName
    .replace(/\s*-\s*.*$/, '')
    .toUpperCase()
    .replace(/SANTO DOMINGO/g, 'STO DGO')
    .replace(/PUERTO PLATA/g, 'PTO PLATA');
}

// Funci√≥n para validar imagen - EXACTO del original
function getValidImage(imageUrl: string, fallbackType: string = 'city', index: number = 0): string {
  const isValidUrl = imageUrl && (
    imageUrl.startsWith('http') ||
    imageUrl.startsWith('https') ||
    imageUrl.startsWith('//') ||
    imageUrl.startsWith('/') ||
    imageUrl.includes('unsplash.com') ||
    imageUrl.includes('cloudinary.com') ||
    imageUrl.includes('amazonaws.com')
  );

  if (isValidUrl) {
    if (imageUrl.startsWith('//')) {
      return `https:${imageUrl}`;
    }
    if (imageUrl.startsWith('/') && !imageUrl.startsWith('//')) {
      return imageUrl;
    }
    return imageUrl;
  }

  const fallbacks = {
    city: [
      'https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=400&h=300&fit=crop&auto=format',
      'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=400&h=300&fit=crop&auto=format',
      'https://images.unsplash.com/photo-1486299267070-83823f5448dd?w=400&h=300&fit=crop&auto=format',
      'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=400&h=300&fit=crop&auto=format',
    ],
    sector: [
      'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop&auto=format',
      'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400&h=300&fit=crop&auto=format',
      'https://images.unsplash.com/photo-1570129477492-45c003edd2be?w=400&h=300&fit=crop&auto=format',
      'https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?w=400&h=300&fit=crop&auto=format',
    ]
  };

  const typeImages = fallbacks[fallbackType] || fallbacks.city;
  return typeImages[index % typeImages.length];
}

// Procesar ubicaciones
const processedLocations = locations
  .map((location: any, index: number) => {
    const originalName = location.title || location.titulo || location.name || location.nombre || 'Ubicaci√≥n';
    const billboardName = createBillboardName(originalName);
    const image = getValidImage(location.image || location.imagen || location.thumbnail || location.image_url || '', location.type || 'city', index);
    const url = location.url || location.slug ? `${baseUrl}/propiedades?ubicacion=${location.slug || location.id}` : '#';
    const propertyCount = location.availableProperties || location.property_count || location.count || location.propiedades_count || 0;
    const priceFrom = location.priceFrom || location.price_from || location.precio_minimo || location.minPrice || 'Consultar';
    const priority = location.priority || 0;

    return {
      billboardName,
      originalName,
      image,
      url,
      propertyCount,
      priceFrom,
      priority,
      type: location.type || 'city'
    };
  })
  .filter(loc => loc.propertyCount > 0)
  .sort((a, b) => b.priority - a.priority)
  .slice(0, 12);

// URL seg√∫n idioma
const locationsUrl = language === 'en' ? '/en/locations' :
                     language === 'fr' ? '/fr/emplacements' :
                     '/ubicaciones';

console.log(`üéØ [PopularLocations] Mostrando ${processedLocations.length} ubicaciones`);
---

<section 
  class="popular-locations-clic py-16"
  style={`
    --pl-primary: ${colorPrimario};
    --pl-text: ${colorTexto};
    --pl-text-secondary: ${colorTextoSecondary};
    --pl-bg: ${colorFondo};
    --pl-border: ${colorBorde};
    --pl-border-hover: ${colorBordeHover};
    --pl-text-hover: ${colorTextoHover};
    background-color: var(--pl-bg);
  `}
>
  <div class="container mx-auto px-4">

    {/* Encabezado - EXACTO del original */}
    <div class="text-center mb-12">
      <h2 class="locations-title text-3xl md:text-4xl font-bold mb-4">
        {finalTitle}
      </h2>
      {finalSubtitle && (
        <p class="locations-subtitle text-lg max-w-3xl mx-auto">
          {finalSubtitle}
        </p>
      )}
    </div>

    {/* Carrusel - EXACTO del original */}
    <div class="relative">
      {/* Botones de navegaci√≥n */}
      <div class="absolute -top-16 right-0 z-10 flex gap-2">
        <button
          id="locations-prev"
          class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label={t.previousLocations}
        >
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <button
          id="locations-next"
          class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label={t.moreLocations}
        >
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
      </div>

      {/* Contenedor del carrusel */}
      <div class="overflow-hidden">
        <div
          id="locations-track"
          class="flex gap-6 transition-transform duration-300 ease-out"
        >
          {processedLocations.map((location, index) => (
            <div class="flex-shrink-0 w-56">
              <a
                href={location.url}
                class="block group relative overflow-hidden rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
                title={location.originalName}
              >
                <div class="relative aspect-[4/3]">
                  <img
                    src={location.image}
                    alt={`${t.propertiesIn} ${location.originalName}`}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading={index < 4 ? "eager" : "lazy"}
                    onerror={`this.src='${getValidImage('', location.type, index)}'`}
                  />

                  {/* Overlay con gradiente mejorado - EXACTO del original */}
                  <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/40 to-black/10"></div>

                  {/* Contenido centrado verticalmente - EXACTO del original */}
                  <div class="absolute inset-0 flex flex-col justify-center items-center text-center text-white px-4">
                    {/* Nombre estilo VALLA PUBLICITARIA - Con hover color primario */}
                    <h3 class="location-name text-xl font-black mb-6 transition-all duration-300 leading-tight tracking-wide text-white group-hover:scale-105 transform">
                      {location.billboardName}
                    </h3>

                    {/* Info de propiedades y precio en la parte inferior - EXACTO del original */}
                    <div class="absolute bottom-4 left-4 right-4 flex justify-between items-end">
                      <div class="text-left">
                        <div class="text-sm font-semibold text-white">
                          {location.propertyCount} {t.properties}
                        </div>
                        <div class="text-xs opacity-75">
                          {t.from} {typeof location.priceFrom === 'number' ? `$${location.priceFrom.toLocaleString()}` : location.priceFrom}
                        </div>
                      </div>
                      <svg class="location-arrow w-4 h-4 group-hover:translate-x-1 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          ))}
        </div>
      </div>
    </div>

    {/* CTA - EXACTO del original */}
    <div class="text-center mt-10">
      <a
        href={locationsUrl}
        class="locations-cta inline-flex items-center gap-2 px-6 py-3 bg-white rounded-lg transition-all duration-300 font-medium group"
      >
        {t.viewAllLocations}
        <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
        </svg>
      </a>
    </div>
  </div>
</section>

<style>
  .popular-locations-clic {
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, sans-serif;
  }

  .locations-title {
    color: var(--pl-text);
  }

  .locations-subtitle {
    color: var(--pl-text-secondary);
  }

  .location-name {
    color: #fff;
  }

  .location-name:hover,
  .group:hover .location-name {
    color: var(--pl-primary);
  }

  .location-arrow {
    color: #fff;
  }

  .group:hover .location-arrow {
    color: var(--pl-primary);
  }

  .locations-cta {
    color: var(--pl-text);
    border: 1px solid var(--pl-border);
    background-color: #ffffff;
  }

  .locations-cta:hover {
    background-color: #f9fafb;
    border-color: var(--pl-border-hover);
    color: var(--pl-text-hover);
  }

  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
// Script de carrusel - EXACTO del original
document.addEventListener('DOMContentLoaded', function() {
  const track = document.getElementById('locations-track');
  const prevBtn = document.getElementById('locations-prev');
  const nextBtn = document.getElementById('locations-next');

  if (!track || !prevBtn || !nextBtn) return;

  let currentIndex = 0;
  const itemWidth = 224; // w-56
  const gap = 24;
  const moveDistance = itemWidth + gap;
  const totalItems = track.children.length;
  const visibleItems = Math.min(4, totalItems);
  const maxIndex = Math.max(0, totalItems - visibleItems);

  function updateCarousel() {
    const translateX = currentIndex * moveDistance;
    track.style.transform = `translateX(-${translateX}px)`;

    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex >= maxIndex;

    prevBtn.style.opacity = currentIndex === 0 ? '0.5' : '1';
    nextBtn.style.opacity = currentIndex >= maxIndex ? '0.5' : '1';
  }

  prevBtn.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      updateCarousel();
    }
  });

  nextBtn.addEventListener('click', () => {
    if (currentIndex < maxIndex) {
      currentIndex++;
      updateCarousel();
    }
  });

  updateCarousel();
});
</script>
