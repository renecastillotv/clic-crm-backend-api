---
/**
 * [...slug].astro
 * 
 * Esta ruta captura URLs que NO empiezan con /tenant/
 * En desarrollo, todas las rutas deberían ser /tenant/[tenantId]/...
 * 
 * Esta ruta solo se usa como fallback o en casos especiales.
 * La mayoría de las rutas deberían pasar por /tenant/[tenantId]/[...slug]
 */

// Si llegamos aquí, es porque la URL no es /tenant/[tenantSlug]/...
// Redirigir al primer tenant en desarrollo usando su slug
const isDevelopment = import.meta.env.DEV;

if (isDevelopment) {
  let tenantSlug: string | null = null;
  try {
    const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';
    const tenantResponse = await fetch(`${API_URL}/api/tenants/first`);
    if (tenantResponse.ok) {
      const tenant = await tenantResponse.json();
      tenantSlug = tenant.slug;
    }
  } catch (error) {
    console.warn('No se pudo obtener tenant:', error);
  }

  if (tenantSlug) {
    // Obtener el pathname actual y redirigir a /tenant/[tenantSlug]/[pathname]
    const slug = Astro.params.slug;
    let pathname = '/';

    if (slug) {
      if (Array.isArray(slug)) {
        const joined = slug.filter(s => s !== undefined && s !== null && s !== '').join('/');
        pathname = joined ? '/' + joined : '/';
      } else if (typeof slug === 'string' && slug.trim() !== '') {
        pathname = '/' + slug.trim();
      }
    }

    // Normalizar
    pathname = (pathname || '').trim();
    if (!pathname || pathname === '') {
      pathname = '/';
    }
    if (!pathname.startsWith('/')) {
      pathname = '/' + pathname;
    }
    pathname = pathname.replace(/\/+/g, '/');
    if (pathname.length > 1 && pathname.endsWith('/')) {
      pathname = pathname.slice(0, -1);
    }

    // Redirigir a la estructura correcta
    const redirectPath = pathname === '/' 
      ? `/tenant/${tenantSlug}/`
      : `/tenant/${tenantSlug}${pathname}`;
    
    return Astro.redirect(redirectPath);
  }
}

return Astro.redirect('/404');
---

<div>Redirigiendo...</div>

